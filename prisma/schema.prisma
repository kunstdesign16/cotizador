generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
  // directUrl is optional - only needed for migrations in development
  // directUrl = env("POSTGRES_URL_NON_POOLING")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("staff")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  quotes    Quote[]
  projects  Project[]
}

model Client {
  id        String   @id @default(cuid())
  name      String
  company   String?
  email     String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  quotes    Quote[]
  projects  Project[]
  incomes   Income[]
}

model Project {
  id           String    @id @default(cuid())
  name         String
  description  String?
  status           ProjectStatus @default(draft)
  financialStatus  String        @default("ABIERTO") // ABIERTO, CERRADO
  isArchived       Boolean   @default(false)
  
  // Financials (Calculated or snapshotted)
  totalCotizado Float    @default(0)
  totalIngresado Float   @default(0)
  totalEgresado  Float   @default(0)

  // Relations
  clientId     String
  client       Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  userId       String?
  user         User?     @relation(fields: [userId], references: [id])
  
  quotes       Quote[]
  supplierOrders SupplierOrder[]
  supplierTasks  SupplierTask[]
  incomes        Income[]
  expenses       VariableExpense[]

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Quote {
  id           String      @id @default(cuid())
  project_name String
  date         DateTime    @default(now())
  status       QuoteStatus @default(draft)
  // Financials
  deliveryDate DateTime?
  version      Int         @default(1)
  
  // Financials
  subtotal     Float       @default(0)
  iva_rate     Float       @default(0.16)
  iva_amount   Float       @default(0)
  isr_rate     Float       @default(0)
  isr_amount   Float       @default(0)
  profit_rate  Float       @default(0) // Margin percentage
  profit_amount Float      @default(0)
  total        Float       @default(0)

  // Relations
  clientId     String
  client       Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  userId       String?
  user         User?       @relation(fields: [userId], references: [id])
  
  projectId    String?
  project      Project?    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  items        QuoteItem[]

  isApproved    Boolean   @default(false)

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  
  supplierOrders SupplierOrder[]
  supplierTasks  SupplierTask[]
  incomes        Income[]
  expenses       VariableExpense[]
}

model QuoteItem {
  id                String   @id @default(cuid())
  quoteId           String
  quote             Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  concept           String
  quantity          Float    @default(1)
  
  // Product Reference (optional - for items from supplier catalog)
  productId         String?
  product           Product? @relation(fields: [productId], references: [id])
  productCode       String?  // Snapshot of product code at time of quote
  productName       String?  // Snapshot of product name
  supplierPrice     Float?   // Snapshot of supplier price at time of quote
  
  // Cost Analysis
  internal_unit_cost Float   @default(0)
  
  // Breakdown
  cost_article      Float    @default(0)
  cost_workforce    Float    @default(0) // Personalización / Mano de obra
  cost_packaging    Float    @default(0)
  cost_transport    Float    @default(0)
  cost_equipment    Float    @default(0) // Equipos / Insumos
  cost_other        Float    @default(0)

  profit_margin     Float    @default(0) // Percentage (e.g., 0.30 for 30%)
  
  unit_cost         Float    @default(0) // Client facing price (Calculated)
  subtotal          Float    @default(0) // quantity * unit_cost

  isSubItem         Boolean  @default(false)

  // Order linkage
  orderCreated      Boolean  @default(false)
  supplierOrderId   String?  @unique
  supplierOrder     SupplierOrder? @relation("QuoteItemToOrder", fields: [supplierOrderId], references: [id])
}



enum SupplierType {
  RAW_MATERIAL
  SERVICE
  FINISHED_PRODUCT
}

model Supplier {
  id        String    @id @default(cuid())
  name      String
  type      SupplierType @default(RAW_MATERIAL)
  products  Product[]
  orders    SupplierOrder[]
  tasks     SupplierTask[]
  expenses  VariableExpense[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model SupplierOrder {
  id           String    @id @default(cuid())
  supplierId   String
  supplier     Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  quoteId      String?
  quote        Quote?    @relation(fields: [quoteId], references: [id])
  taskId       String?
  task         SupplierTask? @relation(fields: [taskId], references: [id])
  status       String    @default("PENDING") // PENDING, ORDERED, RECEIVED
  paymentStatus String   @default("PENDING") // PENDING, PAID
  expectedDate DateTime?
  items        Json      // [{ code, quantity, name }]
  
  projectId    String?
  project      Project?    @relation(fields: [projectId], references: [id])
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  expenses     VariableExpense[]

  // Link to source quote item
  quoteItemId  String?   @unique
  quoteItem    QuoteItem? @relation("QuoteItemToOrder")
}

model SupplierTask {
  id           String    @id @default(cuid())
  supplierId   String
  supplier     Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  quoteId      String?
  quote        Quote?    @relation(fields: [quoteId], references: [id])
  orders       SupplierOrder[]
  description  String
  status       String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  priority     String    @default("MEDIUM")  // LOW, MEDIUM, HIGH, URGENT
  expectedDate DateTime?
  deliveryDate DateTime?
  
  projectId    String?
  project      Project?    @relation(fields: [projectId], references: [id])
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Product {
    id         String   @id @default(cuid())
    code       String   // Código Hijo
    parentCode String?  // Código Padre
    name       String
    category   String?
    price      Float    // Precio Base
    priceType  String?  // NORMAL, ÚNICO, OUTLET
    supplierId String
    supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
    quoteItems QuoteItem[] // Products can be referenced in quotes
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    @@unique([supplierId, code])
}

model FixedExpense {
    id          String   @id @default(cuid())
    description String
    amount      Float
    category    String?  // Renta, Servicios, Nómina, Otros
    date        DateTime @default(now())
    recurring   Boolean  @default(false)
    frequency   String?  // MONTHLY, ANNUALLY
    isActive    Boolean  @default(true)
    paymentMethod String? // TRANSFER, CASH, CREDIT_CARD
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
}

model Income {
    id            String   @id @default(cuid())
    description   String?
    amount        Float
    iva           Float    @default(0)
    date          DateTime @default(now())
    status        String   @default("PAID") // PENDING, PAID, PARTIAL
    paymentMethod String?  // TRANSFER, CASH, CHECK
    
    // Relations
    clientId      String?
    client        Client?  @relation(fields: [clientId], references: [id])
    quoteId       String?
    quote         Quote?   @relation(fields: [quoteId], references: [id])
    
    // For manual entries not linked to a quote
    projectId     String?  // Optional external project reference if no quote exists
    project       Project? @relation(fields: [projectId], references: [id])
    
    notes         String?
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

model VariableExpense {
    id            String   @id @default(cuid())
    description   String
    amount        Float
    iva           Float    @default(0)
    category      String?  // MATERIAL, LABOR, SHIPPING, etc.
    date          DateTime @default(now())
    paymentMethod String?
    
    // Relations
    supplierId    String?
    supplier      Supplier? @relation(fields: [supplierId], references: [id])
    supplierOrderId String?
    supplierOrder SupplierOrder? @relation(fields: [supplierOrderId], references: [id])
    
    // Link to project
    quoteId       String?
    quote         Quote?   @relation(fields: [quoteId], references: [id])
    
    projectId     String?
    project       Project? @relation(fields: [projectId], references: [id])
    
    proofFile     String?  // URL to receipt/invoice
    
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}


enum ProjectStatus {
  draft
  active
  closed
  cancelled
}

enum QuoteStatus {
  draft
  approved
  rejected
  replaced
}

