generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("staff")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  quotes    Quote[]
}

model Client {
  id        String   @id @default(cuid())
  name      String
  company   String?
  email     String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  quotes    Quote[]
}

model Quote {
  id           String      @id @default(cuid())
  project_name String
  date         DateTime    @default(now())
  status       String      @default("DRAFT") // DRAFT, SAVED, SENT, APPROVED, FACTURADO, COBRADO
  // Financials
  deliveryDate DateTime?
  
  // Financials
  subtotal     Float       @default(0)
  iva_rate     Float       @default(0.16)
  iva_amount   Float       @default(0)
  isr_rate     Float       @default(0)
  isr_amount   Float       @default(0)
  profit_rate  Float       @default(0) // Margin percentage
  profit_amount Float      @default(0)
  total        Float       @default(0)

  // Relations
  clientId     String
  client       Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  userId       String?
  user         User?       @relation(fields: [userId], references: [id])
  
  items        QuoteItem[]

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  
  supplierOrders SupplierOrder[]
  supplierTasks  SupplierTask[]
}

model QuoteItem {
  id                String   @id @default(cuid())
  quoteId           String
  quote             Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  concept           String
  quantity          Float    @default(1)
  
  // Product Reference (optional - for items from supplier catalog)
  productId         String?
  product           Product? @relation(fields: [productId], references: [id])
  productCode       String?  // Snapshot of product code at time of quote
  productName       String?  // Snapshot of product name
  supplierPrice     Float?   // Snapshot of supplier price at time of quote
  
  // Cost Analysis
  internal_unit_cost Float   @default(0)
  
  // Breakdown
  cost_article      Float    @default(0)
  cost_workforce    Float    @default(0) // Personalización / Mano de obra
  cost_packaging    Float    @default(0)
  cost_transport    Float    @default(0)
  cost_equipment    Float    @default(0) // Equipos / Insumos
  cost_other        Float    @default(0)

  profit_margin     Float    @default(0) // Percentage (e.g., 0.30 for 30%)
  
  unit_cost         Float    @default(0) // Client facing price (Calculated)
  subtotal          Float    @default(0) // quantity * unit_cost
}



enum SupplierType {
  RAW_MATERIAL
  SERVICE
  FINISHED_PRODUCT
}

model Supplier {
  id        String    @id @default(cuid())
  name      String
  type      SupplierType @default(RAW_MATERIAL)
  products  Product[]
  orders    SupplierOrder[]
  tasks     SupplierTask[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model SupplierOrder {
  id           String    @id @default(cuid())
  supplierId   String
  supplier     Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  quoteId      String?
  quote        Quote?    @relation(fields: [quoteId], references: [id])
  status       String    @default("PENDING") // PENDING, ORDERED, RECEIVED
  paymentStatus String   @default("PENDING") // PENDING, PAID
  expectedDate DateTime?
  items        Json      // [{ code, quantity, name }]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model SupplierTask {
  id           String    @id @default(cuid())
  supplierId   String
  supplier     Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  quoteId      String?
  quote        Quote?    @relation(fields: [quoteId], references: [id])
  description  String
  status       String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  priority     String    @default("MEDIUM")  // LOW, MEDIUM, HIGH, URGENT
  expectedDate DateTime?
  deliveryDate DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Product {
    id         String   @id @default(cuid())
    code       String   // Código Hijo
    parentCode String?  // Código Padre
    name       String
    category   String?
    price      Float    // Precio Base
    priceType  String?  // NORMAL, ÚNICO, OUTLET
    supplierId String
    supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
    quoteItems QuoteItem[] // Products can be referenced in quotes
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    @@unique([supplierId, code])
}
